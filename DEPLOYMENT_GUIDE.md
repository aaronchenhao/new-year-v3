# 项目部署指南

## 1. 管理端密码配置

管理端密码可以通过以下方式配置：

### 1.1 环境变量配置（推荐）
- 在 `.env` 文件中设置 `ADMIN_PASSWORD` 变量
- 示例：
  ```env
  # Admin Configuration
  ADMIN_PASSWORD=your_secure_password
  ```

### 1.2 代码默认值
- 如果未设置环境变量，系统会使用默认密码 `admin123`
- 相关代码位于 `admin/server/middleware/auth.js`：
  ```javascript
  const adminPassword = process.env.ADMIN_PASSWORD || 'admin123';
  ```

## 2. 腾讯云 1Panel 部署步骤

### 2.1 准备工作

1. **登录腾讯云控制台**
   - 访问 https://console.cloud.tencent.com/
   - 登录您的腾讯云账号

2. **创建云服务器实例**
   - 推荐配置：2核4G内存，50GB磁盘
   - 操作系统：Ubuntu 22.04 LTS
   - 安全组：开放 80、443、3001、3002 端口

3. **安装 1Panel**
   - 连接到云服务器
   - 执行安装命令：
     ```bash
     curl -sSL https://resource.fit2cloud.com/1panel/package/quick_start.sh | bash
     ```
   - 安装完成后，根据提示访问 1Panel 管理界面

4. **安装必要组件**
   - 在 1Panel 中安装：
     - Nginx
     - Redis
     - Node.js 16+

### 2.2 部署前端

1. **构建前端项目**
   - 在本地执行构建命令：
     ```bash
     npm run build
     ```
   - 构建产物会生成在 `dist` 目录

2. **创建网站**
   - 在 1Panel 中，进入「网站」→「创建网站」
   - 填写网站信息：
     - 网站名称：牛马宇宙前端
     - 域名：填写您的域名（如无域名，可使用服务器 IP）
     - 网站类型：静态网站
     - 根目录：选择一个目录，如 `/www/wwwroot/horse-universe-frontend`

3. **上传构建产物**
   - 将本地 `dist` 目录中的所有文件上传到 1Panel 中创建的网站根目录

4. **配置 Nginx**
   - 在网站设置中，配置 Nginx 反向代理（如需）
   - 确保静态文件能够正确访问

### 2.3 部署用户服务端

1. **创建应用**
   - 在 1Panel 中，进入「应用」→「Node.js 应用」→「创建应用」
   - 填写应用信息：
     - 应用名称：牛马宇宙用户服务端
     - 运行目录：选择一个目录，如 `/www/wwwroot/horse-universe-backend`
     - 启动文件：`server.js`
     - 端口：3001

2. **上传代码**
   - 将本地 `server` 目录中的所有文件上传到应用运行目录

3. **安装依赖**
   - 在应用管理中，点击「依赖管理」→「安装依赖」
   - 执行 `npm install` 命令

4. **配置环境变量**
   - 在应用管理中，点击「环境变量」→「添加环境变量」
   - 添加以下环境变量：
     - `REDIS_HOST`：Redis 服务器地址
     - `REDIS_PORT`：Redis 端口（默认 6379）
     - `REDIS_PASSWORD`：Redis 密码（如有）
     - `PORT`：服务端口（默认 3001）
     - `GEMINI_API_KEY`：Google Gemini API 密钥（如有）

5. **启动应用**
   - 在应用管理中，点击「启动」按钮
   - 确保应用正常运行

### 2.4 部署管理端

#### 2.4.1 管理端前端

1. **创建网站**
   - 在 1Panel 中，进入「网站」→「创建网站」
   - 填写网站信息：
     - 网站名称：牛马宇宙管理端前端
     - 域名：填写您的域名（如无域名，可使用服务器 IP + 路径）
     - 网站类型：静态网站
     - 根目录：选择一个目录，如 `/www/wwwroot/horse-universe-admin-frontend`

2. **上传代码**
   - 将本地 `admin/client` 目录中的所有文件上传到网站根目录

#### 2.4.2 管理端后端

1. **创建应用**
   - 在 1Panel 中，进入「应用」→「Node.js 应用」→「创建应用」
   - 填写应用信息：
     - 应用名称：牛马宇宙管理端后端
     - 运行目录：选择一个目录，如 `/www/wwwroot/horse-universe-admin-backend`
     - 启动文件：`index.js`
     - 端口：3002

2. **上传代码**
   - 将本地 `admin/server` 目录中的所有文件上传到应用运行目录

3. **安装依赖**
   - 在应用管理中，点击「依赖管理」→「安装依赖」
   - 执行 `npm install` 命令

4. **配置环境变量**
   - 在应用管理中，点击「环境变量」→「添加环境变量」
   - 添加以下环境变量：
     - `REDIS_HOST`：Redis 服务器地址
     - `REDIS_PORT`：Redis 端口（默认 6379）
     - `REDIS_PASSWORD`：Redis 密码（如有）
     - `ADMIN_PORT`：服务端口（默认 3002）
     - `ADMIN_PASSWORD`：管理端密码（推荐设置强密码）

5. **启动应用**
   - 在应用管理中，点击「启动」按钮
   - 确保应用正常运行

### 2.5 配置域名和 SSL（可选）

1. **域名解析**
   - 在域名提供商处，将域名解析到您的服务器 IP

2. **SSL 证书**
   - 在 1Panel 中，进入「网站」→「SSL 证书」
   - 申请或上传 SSL 证书
   - 启用 HTTPS

### 2.6 测试和验证

1. **前端测试**
   - 访问前端域名，确保页面正常加载
   - 测试游戏功能，确保与后端服务正常通信

2. **管理端测试**
   - 访问管理端前端域名
   - 使用配置的管理端密码登录
   - 测试管理功能，确保与管理端后端正常通信

3. **服务端测试**
   - 检查用户服务端和管理端后端的运行状态
   - 查看日志，确保无错误信息

## 3. 常见问题排查

### 3.1 服务无法启动
- 检查端口是否被占用
- 检查环境变量配置是否正确
- 查看应用日志，分析错误原因

### 3.2 前端无法连接后端
- 检查后端服务是否正常运行
- 检查前端 API 地址配置是否正确
- 检查防火墙设置，确保端口开放

### 3.3 管理端登录失败
- 检查管理端密码是否正确
- 检查管理端后端服务是否正常运行
- 检查环境变量 `ADMIN_PASSWORD` 是否正确设置

### 3.4 Redis 连接失败
- 检查 Redis 服务是否正常运行
- 检查 Redis 配置是否正确
- 检查网络连接是否正常

## 4. 维护和更新

### 4.1 代码更新
- 前端：重新构建并上传 `dist` 目录
- 后端：上传更新的代码，重启应用

### 4.2 依赖更新
- 在应用管理中，执行 `npm update` 命令

### 4.3 日志管理
- 在 1Panel 中，查看应用日志，及时发现和解决问题

### 4.4 备份
- 定期备份代码和数据
- 建议使用 1Panel 的备份功能

## 5. 安全建议

1. **使用强密码**
   - 为管理端设置复杂的密码
   - 定期更换密码

2. **限制访问**
   - 为管理端设置 IP 访问限制
   - 使用 HTTPS 加密传输

3. **定期更新**
   - 及时更新依赖包，修复安全漏洞
   - 定期检查系统和应用的安全状态

4. **监控和告警**
   - 配置服务器监控
   - 设置异常告警机制

---

希望本指南对您的部署工作有所帮助！如有任何问题，请随时咨询。