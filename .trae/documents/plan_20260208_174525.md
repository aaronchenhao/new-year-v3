# å®ç°æ˜¾ç¤ºä¸Šä¸€æ¡æ¶ˆæ¯ç”¨æˆ·åçš„åŠŸèƒ½

## åŠŸèƒ½éœ€æ±‚

1. åœ¨"æ¥è‡ªä¸Šä¸€åŒ¹é©¬çš„ç¥ç¦"ä¸­æ˜¾ç¤ºä¸Šä¸€æ¡æ¶ˆæ¯çš„ç”¨æˆ·å
2. è®¾è®¡ç¬¦åˆæ¸¸æˆä¸»é¢˜çš„æ˜¾ç¤ºæ–¹å¼
3. ç¡®ä¿åç«¯ API è¿”å›åŒ…å«ç”¨æˆ·åçš„æ¶ˆæ¯æ•°æ®

## æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. ä¿®æ”¹åç«¯ API

* **ä¿®æ”¹è·å–æ¶ˆæ¯æ¥å£**ï¼šåœ¨ `server.js` ä¸­ä¿®æ”¹ `GET /api/messages/:horseId` æ¥å£ï¼Œè¿”å›åŒ…å«ç”¨æˆ·åçš„å®Œæ•´æ¶ˆæ¯å¯¹è±¡

* **æ¶ˆæ¯æ ¼å¼**ï¼šè¿”å› `{ content: string, username: string }` æ ¼å¼çš„æ•°æ®

### 2. ä¿®æ”¹å‰ç«¯ä»£ç 

* **ä¿®æ”¹çŠ¶æ€ç®¡ç†**ï¼šåœ¨ `App.tsx` ä¸­æ·»åŠ  `incomingMessageUsername` çŠ¶æ€ï¼Œç”¨äºå­˜å‚¨ä¸Šä¸€æ¡æ¶ˆæ¯çš„ç”¨æˆ·å

* **ä¿®æ”¹æ¶ˆæ¯è·å–**ï¼šä¿®æ”¹ `useEffect` ä¸­çš„ `fetchMessage` å‡½æ•°ï¼Œå¤„ç†åŒ…å«ç”¨æˆ·åçš„å“åº”æ•°æ®

* **ä¿®æ”¹ç•Œé¢æ˜¾ç¤º**ï¼šåœ¨æ˜¾ç¤ºæ¶ˆæ¯æ—¶ï¼ŒåŒæ—¶æ˜¾ç¤ºç”¨æˆ·åï¼Œè®¾è®¡ç¬¦åˆæ¸¸æˆä¸»é¢˜çš„æ˜¾ç¤ºæ–¹å¼

### 3. ç•Œé¢è®¾è®¡

* **æ˜¾ç¤ºä½ç½®**ï¼šåœ¨æ¶ˆæ¯å†…å®¹ä¸‹æ–¹æ˜¾ç¤ºç”¨æˆ·å

* **æ ·å¼è®¾è®¡**ï¼šä½¿ç”¨å°å·å­—ä½“ï¼Œç°è‰²æˆ–æµ…è‰²ï¼Œå¸¦æœ‰ç‰›é©¬ç›¸å…³çš„å›¾æ ‡

* **æ–‡æ¡ˆé£æ ¼**ï¼šä¿æŒæ¸¸æˆçš„å¹½é»˜é£æ ¼ï¼Œå¦‚"æ¥è‡ªä¸Šä¸€åŒ¹\[ç”¨æˆ·å]çš„ç¥ç¦"

### 4. ä»£ç å®ç°

#### åç«¯ä¿®æ”¹

```javascript
// ä¿®æ”¹ server.js ä¸­çš„è·å–æ¶ˆæ¯æ¥å£
app.get('/api/messages/:horseId', async (req, res) => {
  try {
    const { horseId } = req.params;
    const key = `horse:messages:${horseId}`;
    
    // è·å–æœ€æ–°çš„ 10 æ¡æ¶ˆæ¯
    const messages = await redis.lrange(key, 0, 9);
    
    if (messages.length > 0) {
      // éšæœºé€‰æ‹©ä¸€æ¡æ¶ˆæ¯
      const randomIndex = Math.floor(Math.random() * messages.length);
      const messageObj = JSON.parse(messages[randomIndex]);
      res.json({ 
        success: true, 
        message: messageObj.content,
        username: messageObj.username 
      });
    } else {
      res.json({ 
        success: false, 
        message: 'è¿™æ˜¯ä½ çš„é¦–æ¡é©¬è¹„å°ï¼Œæ²¡äººæ¥ä½ å“¦',
        username: '' 
      });
    }
  } catch (error) {
    console.error('Error getting message:', error);
    res.json({ 
      success: false, 
      message: 'è·å–ç¥ç¦å¤±è´¥ï¼Œè¯·é‡è¯•',
      username: '' 
    });
  }
});
```

#### å‰ç«¯ä¿®æ”¹

```javascript
// 1. æ·»åŠ çŠ¶æ€ç®¡ç†
const [incomingMessageUsername, setIncomingMessageUsername] = useState('');

// 2. ä¿®æ”¹æ¶ˆæ¯è·å–å‡½æ•°
useEffect(() => {
  if (step === GameStep.RELAY && myHorse) {
    const fetchMessage = async () => {
      try {
        const response = await fetch(`http://172.18.0.2:3001/api/messages/${myHorse.id}`);
        const data = await response.json();
        if (data.success) {
          setIncomingMessage(data.message);
          setIncomingMessageUsername(data.username);
        } else {
          setIncomingMessage(data.message || "è¿™æ˜¯ä½ çš„é¦–æ¡é©¬è¹„å°ï¼Œæ²¡äººæ¥ä½ å“¦");
          setIncomingMessageUsername('');
        }
      } catch (error) {
        console.error('è·å–æ¶ˆæ¯å¤±è´¥:', error);
        setIncomingMessage("è¿™æ˜¯ä½ çš„é¦–æ¡é©¬è¹„å°ï¼Œæ²¡äººæ¥ä½ å“¦");
        setIncomingMessageUsername('');
      }
    };
    fetchMessage();
  }
}, [step, myHorse]);

// 3. ä¿®æ”¹æ¶ˆæ¯æ˜¾ç¤ºç•Œé¢
// åœ¨ renderRelay å‡½æ•°ä¸­ä¿®æ”¹æ¶ˆæ¯æ˜¾ç¤ºéƒ¨åˆ†
<div className="bg-[#FFFDF7] p-6 rounded-[2rem] pop-shadow border-4 border-black font-bold text-lg text-[#9B1C1C] relative">
  "{incomingMessage}"
  {incomingMessageUsername && (
    <div className="mt-2 text-xs font-bold text-[#A1887F] flex items-center justify-end gap-1">
      <span>ğŸ</span>
      <span>æ¥è‡ªä¸Šä¸€åŒ¹{incomingMessageUsername}çš„ç¥ç¦</span>
    </div>
  )}
</div>
```

### 5. æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨æœåŠ¡**ï¼šå¯åŠ¨ Redisã€åç«¯æœåŠ¡å’Œå‰ç«¯æœåŠ¡
2. **æäº¤æ¶ˆæ¯**ï¼šä½¿ç”¨ API å·¥å…·æˆ–æ¸¸æˆç•Œé¢æäº¤ä¸€æ¡åŒ…å«ç”¨æˆ·åçš„æ¶ˆæ¯
3. **æµ‹è¯•è·å–**ï¼šå†æ¬¡è¿›å…¥æ¸¸æˆï¼Œé€‰æ‹©ç›¸åŒç±»å‹çš„é©¬ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºä¸Šä¸€æ¡æ¶ˆæ¯çš„ç”¨æˆ·å
4. **éªŒè¯æ ·å¼**ï¼šç¡®ä¿ç”¨æˆ·åæ˜¾ç¤ºç¬¦åˆæ¸¸æˆä¸»é¢˜ï¼Œæ ·å¼ç¾è§‚

### 6. æ‰©å±•åŠŸèƒ½

1. **æ¶ˆæ¯æ—¶é—´**ï¼šå¯ä»¥æ·»åŠ æ¶ˆæ¯çš„æ—¶é—´æˆ³ï¼Œæ˜¾ç¤ºæ¶ˆæ¯å‘é€çš„æ—¶é—´
2. **æ¶ˆæ¯æ ‡è¯†**ï¼šå¯ä»¥ä¸ºä¸åŒç”¨æˆ·çš„æ¶ˆæ¯æ·»åŠ ä¸åŒçš„æ ‡è¯†ï¼Œå¦‚é¢œè‰²æˆ–å›¾æ ‡
3. **æ¶ˆæ¯å†å²**ï¼šå¯ä»¥æ·»åŠ æ¶ˆæ¯å†å²è®°å½•ï¼Œæ˜¾ç¤ºå¤šæ¡å†å²æ¶ˆæ¯

### 7. æŠ€æœ¯ä¼˜åŠ¿

* **å…¼å®¹æ€§**ï¼šä¿®æ”¹åçš„ API å‘åå…¼å®¹ï¼Œä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½

* **å¯æ‰©å±•æ€§**ï¼šè®¾è®¡çµæ´»ï¼Œæ˜“äºæ·»åŠ æ›´å¤šæ¶ˆæ¯ç›¸å…³çš„åŠŸèƒ½

* **ç”¨æˆ·ä½“éªŒ**ï¼šæ˜¾ç¤ºç”¨æˆ·åå¯ä»¥å¢åŠ æ¸¸æˆçš„ç¤¾äº¤æ€§å’Œè¶£å‘³æ€§

* **ä»£ç è´¨é‡**ï¼šä¿®æ”¹æœ€å°åŒ–ï¼Œä¿æŒä»£ç ç»“æ„æ¸…æ™°

